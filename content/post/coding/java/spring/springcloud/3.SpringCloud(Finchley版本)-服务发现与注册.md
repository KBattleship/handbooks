![服务注册与服务发现原理](http://www.itmuch.com/images/spring-cloud/service-registry-2.png)

服务提供者、服务消费者、服务发现组件这三者之间的关系大致如下：

- 各个**微服务在启动时，将自己的网络地址等信息注册到服务发现组件中**，服务发现组件会存储这些信息；
- **服务消费者可从服务发现组件查询服务提供者的网络地址**，并使用该地址调用服务提供者的接口；
- 各个微服务与服务发现组件**使用一定机制（例如心跳）通信**。服务发现组件如长时间无法与某微服务实例通信，就会自动注销（即：删除）该实例；
- 当微服务网络地址发生变更（例如实例增减或者IP端口发生变化等）时，会**重新注册**到服务发现组件；
- **客户端缓存**：各个微服务将需要调用服务的地址缓存在本地，并使用一定机制更新（例如定时任务更新、事件推送更新等）。这样既能降低服务发现组件的压力，同时，即使服务发现组件出问题，也不会影响到服务之间的调用。

综上，服务发现组件应具备以下功能。

- **服务注册表**：服务注册表是服务发现组件的核心（其实就是类似于上面的registry表），它用来记录各个微服务的信息，例如微服务的名称、IP、端口等。服务注册表提供查询API和管理API，查询API用于查询可用的微服务实例，管理API用于服务的注册和注销；
- **服务注册与服务发现**：服务注册是指微服务在启动时，将自己的信息注册到服务发现组件上的过程。服务发现是指查询可用微服务列表及其网络地址的机制；
- **服务检查**：服务发现组件使用一定机制定时检测已注册的服务，如发现某实例长时间无法访问，就会从服务注册表中移除该实例。

Spring Cloud为我们提供多种服务发现组件的支持，例如Eureka、Consul（spring-cloud-consul）、Zookeeper（spring-cloud-zookeeper）、Aliaba Nacos（孵化中：spring-cloud-alibaba）、Etcd（孵化中：spring-cloud-etcd）等。