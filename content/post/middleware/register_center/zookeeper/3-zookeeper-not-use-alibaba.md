---
title: " [ Zookeeper ] 3. Zookeeper作为注册中心的缺馅"
date: 2019-11-12T01:36:27+08:00
lastmod: 2019-11-12T01:36:27+08:00
keywords: ['middleware']
description: ""
tags: ['middleware','Zookeeper','Linux','分布式']
categories: ['middleware']
author: ""
---
# Zookeeper作为注册中心的缺馅
## 一、 关于**服务发现中心**
### 1.CAP原理
+ C(Consistency)：一致性

    在更新操作成功后，所有节点在**同一时间**的数据保证一致。
+ A(Availability)：可用性

    服务提供正常服务，并且保证都是正常响应时间。
+ P(Partition Tolerance)：分区容错性

    在分布式系统中，由于某一个节点出现或者网络分区出现异常情况，仍可以提供满足**一致性**或者用性 的服务。
  
### 2.Zookeeper保证CP

1. 当向注册中心查询服务列表时，可以容忍注册中心返回的是在此之前已经注册的信息，但不能接受服务直接不可用的现象
2. 服务注册功能对可用性的标准要高于一致性
3. 在ZK中，存在这样一种情况，如果master节点因为网络故障与其他节点失去联系，剩余节点将会重新进行Leader选举。
4. 在ZK leader选举过程中，是一个耗时操作（大概30-120s，耗时未经实际生产验证），并且选举过程中，ZK集群是处于不可用状态，这时候将会导致服务发现、服务注册处于不可用
5. 云部署环境下，因网络问题导致ZK集群丢失Master节点是大概率事件，虽说服务可以通过重新选举恢复到可用状态，但是漫长的选举过程耗时是不可容忍的。

## 二、Alibaba为什么不使用ZK作为注册中心

### 1. 借助一篇文章示例了解CAP选择

> 网上存在一篇文章[阿里巴巴为什么不用 ZooKeeper 做服务发现?](https://developer.aliyun.com/article/599997)。文中提到一个示例，三个机房进行异地容灾部署，在**机房3**中存在一个**zk节点5**，但是由于网络问题，导致机房3在网络上成为孤岛。这时，ZK集群还是可用的，但是会导致与 **zk节点5** 无法通信，此节点就会无法写入。

此时的状况就是对 **CAP** 三种特性的一个选择。`但是在现实中场景下，是不允许因为防止分区容错 条件下保证 数据的强一致性而舍弃掉可用性。`

+ 在设计注册中心时应该考虑一点，不能因为注册中心的任何原因导致服务间调用出现异常。
+ 其实，在注册中心(服务发现)这个应用场景下，进行CAP的选择，更加注重可用性。毕竟数据不一致在一定时间范围内是可以容忍的。
+ 如果在保证分区容错(P)的情况下，不能保证可用性(A)，就违反了注册中心(服务发现)的设计原则，以及实际生产环境的要求。

### 2. 随时间推移ZK的能力有所下降

+ 在注册中心(服务发现)的场景下，随着大量的服务注册到ZK集群中，频繁的写请求、服务健康检查的心跳机制都会给ZK集群带来压力。
+ 如果通过不同业务使用不同的ZK集群进行服务发现，就会破坏注册中心一开始的设计初衷：不得以自身任何原因破坏掉服务间的互通性。

### 3. ZK自身保证事务的特性
+ ZAB协议处理每一个写请求的同时，会在ZK集群的每一个节点上进行事务日志写入
+ 定期通过内存数据快照同步到磁盘，保证数据一致性、数据持久性、宕机数据可恢复性。注册中心保存的数据信息包含有：注册成功的服务的可用服务地址信息。但是在 注册中心(服务发现) 的应用场景下，仅是为了保证每次可以正常调用到下游服务，并不关心下游服务的历史信息，所以说一定程度上，持久化这些数据是没有必要的。
+ 但是从另外一个角度，注册中心还是要持久元数据信息的，譬如：服务版本、所在数据中心、服务路由权重、鉴权策略信息等等。
+ 不单单需要提供持久性，同时还需要满足持久化数据的搜索能力。

### 4. 例如Dubbo服务间调用采用ZK作为注册中心
+ 在实际环境中，不能因为ZK集群挂掉，导致服务间调用出现异常。
+ Dubbo服务间调用：Dubbo服务在注册到注册中心后，会将必要的数据信息在本地环境下进行持久化，也就是说，在ZK集群处于瘫痪，并且没有新服务注册进来提供被调用能力时，原有服务间的调用不能收到影响。
+ 注册中心最关键的是在 新服务注册、节点上下线等情况下提供支持。

### 5. 关于异常处理

